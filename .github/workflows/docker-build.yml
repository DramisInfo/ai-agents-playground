name: Docker Build Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-infrastructure:
    name: Build Infrastructure Services
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-infra-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-infra-

      - name: Create environment file
        run: |
          cp .env.example .env
          # Set dummy GitHub token for build (not needed for build, only runtime)
          sed -i 's/your_github_personal_access_token_here/dummy_token_for_ci_build/g' .env

      - name: Generate package lock file
        working-directory: ./portal
        run: npm install --package-lock-only

      - name: Build infrastructure services
        run: |
          DOCKER_BUILDKIT=1 docker compose -f docker-compose.infrastructure.yml build \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            postgres redis portal

      - name: Verify images were created
        run: |
          docker images | grep ai-agents-playground-portal
          docker images | grep pgvector/pgvector
          docker images | grep redis

  build-lessons:
    name: Build Lesson Services
    runs-on: ubuntu-latest
    strategy:
      matrix:
        lesson:
          - name: lesson-01
            path: lessons/lesson-01-support-bot
            service: support-bot
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ matrix.lesson.name }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-${{ matrix.lesson.name }}-

      - name: Build ${{ matrix.lesson.name }}
        run: |
          docker buildx build \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache-new,mode=max \
            --load \
            -t ai-agents-playground-${{ matrix.lesson.service }}:test \
            ${{ matrix.lesson.path }}
      
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Verify image was created
        run: |
          docker images | grep ai-agents-playground-${{ matrix.lesson.service }}

  integration-test:
    name: Integration Test - Start All Services
    runs-on: ubuntu-latest
    needs: [build-infrastructure, build-lessons]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create environment file
        run: |
          cp .env.example .env
          sed -i 's/your_github_personal_access_token_here/dummy_token_for_ci_build/g' .env

      - name: Generate package lock file
        working-directory: ./portal
        run: npm install --package-lock-only

      - name: Start infrastructure services
        run: |
          docker compose -f docker-compose.infrastructure.yml up -d \
            postgres redis portal
          
      - name: Wait for services to be healthy
        run: |
          echo "Waiting for PostgreSQL..."
          timeout 60 bash -c 'until docker exec techflow-postgres pg_isready -U techflow_user; do sleep 2; done'
          
          echo "Waiting for Redis..."
          timeout 60 bash -c 'until docker exec techflow-redis redis-cli ping; do sleep 2; done'
          
          echo "Waiting for Portal..."
          sleep 10
          timeout 60 bash -c 'until curl -f http://localhost:3000 > /dev/null 2>&1; do sleep 2; done'

      - name: Run health checks
        run: |
          # Check PostgreSQL
          docker exec techflow-postgres pg_isready -U techflow_user
          
          # Check Redis
          docker exec techflow-redis redis-cli ping
          
          # Check Portal
          curl -f http://localhost:3000 || exit 1

      - name: Display running containers
        if: always()
        run: docker compose -f docker-compose.infrastructure.yml ps

      - name: Display container logs
        if: always()
        run: |
          echo "=== Portal Logs ==="
          docker compose -f docker-compose.infrastructure.yml logs portal
          echo "=== PostgreSQL Logs ==="
          docker compose -f docker-compose.infrastructure.yml logs postgres
          echo "=== Redis Logs ==="
          docker compose -f docker-compose.infrastructure.yml logs redis

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.infrastructure.yml down -v
