name: Exercise Validation

on:
  pull_request:
    paths:
      - 'exercises/**'
  push:
    branches:
      - main
    paths:
      - 'exercises/**'

jobs:
  validate-exercise-1-1:
    name: Validate Exercise 1.1
    runs-on: ubuntu-latest
    
    # Only run if exercise 1.1 files were modified
    if: |
      contains(github.event.pull_request.changed_files, 'exercises/exercise-1.1/') ||
      contains(github.event.head_commit.modified, 'exercises/exercise-1.1/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run Exercise 1.1 tests
        id: test_exercise
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd exercises/exercise-1.1
          pytest test_agents.py -v --tb=short --color=yes
        continue-on-error: true
      
      - name: Generate test report
        if: always()
        run: |
          cd exercises/exercise-1.1
          pytest test_agents.py --tb=short --color=yes > test_results.txt 2>&1 || true
          echo "test_output<<EOF" >> $GITHUB_OUTPUT
          cat test_results.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        id: test_report
      
      - name: Comment on PR - Success
        if: steps.test_exercise.outcome == 'success' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ğŸ‰ Exercise 1.1 Complete!
            
            Congratulations! All tests passed successfully.
            
            ### âœ… What You Accomplished
            - Created three specialized agents with distinct personalities
            - Wrote effective instructions that shape agent behavior
            - Validated agents respond appropriately to domain-specific questions
            
            ### ğŸš€ Next Steps
            You're ready to move on to **Lesson 1.2: Agent Instructions and Prompting**!
            
            This lesson will dive deeper into:
            - Advanced prompting techniques
            - Instruction patterns and best practices
            - Fine-tuning agent behavior
            
            Keep up the great work! ğŸŒŸ`;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
      
      - name: Comment on PR - Failure
        if: steps.test_exercise.outcome == 'failure' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ğŸ”§ Exercise 1.1 - Tests Failed
            
            Some tests didn't pass yet. Don't worry - this is part of the learning process!
            
            ### ğŸ“‹ Test Results
            <details>
            <summary>Click to see detailed test output</summary>
            
            \`\`\`
            ${{ steps.test_report.outputs.test_output }}
            \`\`\`
            </details>
            
            ### ğŸ’¡ Tips for Success
            
            1. **Read the test output carefully** - it tells you exactly what's expected
            2. **Focus on instructions** - the quality of your agent's instructions directly impacts behavior
            3. **Test locally first** - run \`python test_agents.py\` before pushing
            4. **Review the lesson** - the notebook has examples that can help
            5. **Be specific** - clear, detailed instructions produce better results
            
            ### ğŸ†˜ Common Issues
            
            - **Agent name mismatch**: Ensure exact name matches (e.g., "CustomerServiceAgent")
            - **Instructions too short**: Agents need detailed guidance (>50 characters minimum)
            - **Wrong tone**: Read what each agent should emphasize (empathy, analysis, creativity)
            - **Missing concepts**: Instructions should mention domain-specific terminology
            
            ### ğŸ“š Resources
            - [Lesson 1.1 Notebook](../../training-materials/module-1-foundations/lesson-1.1-first-agent.ipynb)
            - [Exercise README](../../exercises/exercise-1.1/README.md)
            - [ChatAgent Documentation](https://learn.microsoft.com/en-us/python/api/agent-framework-core/agent_framework.chatagent)
            
            Push your changes again when you're ready, and I'll re-run the tests!`;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
      
      - name: Set final status
        if: always()
        run: |
          if [ "${{ steps.test_exercise.outcome }}" == "success" ]; then
            echo "âœ… All tests passed!"
            exit 0
          else
            echo "âŒ Some tests failed. Review the output above."
            exit 1
          fi
